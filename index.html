<!DOCTYPE html>
<html lang="en">
<head>
    <title>Slippi SA Ranked Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="assets/favicon-32.png">
    <link rel="shortcut icon" href="assets/favicon-32.png">

    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  
   <style>
       body { font-family: 'Roboto', Arial, sans-serif; margin: 0; padding: 0; }
       html, body, #map { height: 100%; }
        .interface {
            font-family: 'Roboto', Arial, sans-serif;
            font-size: smaller;
            position: absolute;
            bottom: 10%;
            right: 3%;
            background: #111;
            color: #ffffff;
            padding: 5px;
            border-radius: 10px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .interface label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: inherit;
        }
        .titles {
            font-family: 'Roboto', Arial, sans-serif;
            font-size: smaller;
            position: absolute;
            top: 3%;
            left: 3%;
            background: #111;
            color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .titles label {
            display: block;
            font-size: 14px;
            margin-bottom: 2px;
            color: inherit;
        }
        .titles a { color: #ffffff; }
    </style>
</head>
<body>
    <style>
        .maplibregl-popup {
            max-width: 480px;
            font: 10px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
    </style>

    <div id="map"></div>

    <div class="interface">
        <center><p><strong>Layers</strong></p></center>
          <label>  <input type="checkbox" id="toggle-centroids" checked>
            Most Common Rank
        </label>
        <label>
            <input type="checkbox" id="toggle-polygons" checked>
            Player Count
        </label>
        <label>
            <input type="checkbox" id="toggle-ratings" checked>
            Average Rating
        </label>

    </div>


    <div class="titles">
        <center><p><strong> Slippi Ranked South America Map </strong></p></center>
        <p>Created by <a href="https://github.com/vagnertxr" target="_blank">TXR</a></p>
        <p>Data: <a href="https://caioicy.github.io/slsa/leaderboards/" target="_blank">SLSA Leaderboards (by Caioicy)</a> - Huge thanks! üê∏</p>     
        <p>Sorted by country of origin, not of residence.</p>
        <p>&nbsp;</p>
        <center><p>Last updated: <span id="data"></span> </p></center>
        <center><p>Updates automatically every week</p></center>
        <p>&nbsp;</p>
        <center><p><strong> <a href="https://slippi.gg" target="_blank">Play Slippi Netplay</a></strong></p></center>
    </div>

    <script>



    fetch('https://raw.githubusercontent.com/vagnertxr/game_map/main/docs/data.txt')
        .then(response => response.text())
        .then(data => {
            document.getElementById('data').textContent = data;
        })
        .catch(error => {
            console.error('Erro', error);
        });
    
    </script>
    <script>
        var svgManager;
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [-55, -25],
            zoom: 3
        });

        
        const rankIcons = {
            'BRONZE I': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/B1.svg',
            'BRONZE II': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/B2.svg',
            'BRONZE III': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/B3.svg',
            'SILVER I': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/S1.svg',
            'SILVER II': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/S2.svg',
            'SILVER III': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/S3.svg',
            'GOLD I': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/G1.svg',
            'GOLD II': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/G2.svg',
            'GOLD III': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/G3.svg',
            'DIAMOND I': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/D1.svg',
            'DIAMOND II': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/D2.svg',
            'DIAMOND III': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/D3.svg',
            'PLATINUM I': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/P1.svg',
            'PLATINUM II': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/P2.svg',
            'PLATINUM III': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/P3.svg',
            'GRANDMASTER': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/GM.svg',
            'ALL PENDING': 'https://raw.githubusercontent.com/vagnertxr/game_map/a6d457109fe57d6fc66a72a3b55e743181499a50/assets/PN.svg'
        };


        const loadIcons = async () => {
            const load = async (key, url) => {
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) {
                        console.error('Erro HTTP ao buscar √≠cone', key, url, resp.status);
                        return;
                    }
                    const blob = await resp.blob();

                    
                    try {
                        const bitmap = await createImageBitmap(blob);
                        if (map.hasImage && map.hasImage(key)) {
                            try { map.removeImage(key); } catch (_) {}
                        }
                        map.addImage(key, bitmap);
                        return;
                    } catch (createErr) {
                        
                        const img = new Image();
                        img.onload = () => {
                            try {
                                if (map.hasImage && map.hasImage(key)) {
                                    try { map.removeImage(key); } catch (_) {}
                                }
                                map.addImage(key, img);
                            } catch (e) { console.error('Erro ao adicionar imagem (fallback)', key, e); }
                        };
                        img.onerror = (e) => { console.error('Erro ao carregar imagem fallback', key, url, e); };
                        img.src = URL.createObjectURL(blob);
                        return;
                    }
                } catch (err) {
                    console.error('Erro ao carregar √≠cone', key, url, err);
                }
            };

            for (const [rank, url] of Object.entries(rankIcons)) {
                await load(`icon-${rank}`, url);
            }
        };

        map.on('load', async () => {
            
            if (maplibregl.SvgManager) {
                try { svgManager = new maplibregl.SvgManager(map); } catch (e) { /* ignore */ }
            }
            await loadIcons();

            map.addSource('polygons', {
                type: 'geojson',
                data: 'https://raw.githubusercontent.com/vagnertxr/game_map/main/docs/polygons.geojson'
            });

            map.addSource('centroids', {
                type: 'geojson',
                data: 'https://raw.githubusercontent.com/vagnertxr/game_map/main/docs/centroids.geojson'
            });

            // Fill by average rating
            map.addLayer({
                id: 'ratings-layer',
                type: 'fill',
                source: 'polygons',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'average_rating'],
                        800, '#fffdbd',
                        1200, '#fff952',
                        1500, '#ffbf00',
                        1750, '#ff9f00',
                        2000, '#cc8400'
                    ],
                    'fill-outline-color': '#000000'
                }
            });

            // Fill by player count
            map.addLayer({
                id: 'polygons-layer',
                type: 'fill',
                source: 'polygons',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'player_count'],
                        1, '#e1ffd1',
                        5, '#63c92c',
                        10, '#1f4a07',
                        40, '#0e2900'
                    ],
                    'fill-outline-color': '#000000'
                }
            });

            // Centroids showing most common rank (icon + label)
            map.addLayer({
                id: 'centroids-layer',
                type: 'symbol',
                source: 'centroids',
                layout: {
                    'icon-image': ['concat', 'icon-', ['get', 'most_common_rank']],
                    'icon-size': ['interpolate', ['linear'], ['zoom'], 1, 0.045, 5, 0.1125],
                    'icon-allow-overlap': true,
                    'text-field': ['get', 'most_common_rank'],
                    'text-font': ['Open Sans Semibold'],
                    'text-offset': [0, 1],
                    'text-anchor': 'top'
                },
                paint: {
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 1
                }
            });


            // Popups for polygons and ratings fills
            const showPopup = (e) => {
                const coordinates = e.lngLat;
                const properties = e.features[0].properties;
                const popupContent = `
                    <strong>Country:</strong> ${properties.country || 'N/A'}<br>
                    <strong>Player Count:</strong> ${properties.player_count || 'N/A'}<br>
                    <strong>Average Rating:</strong> ${properties.average_rating || 'N/A'}<br>
                    <strong>Most Common Rank:</strong> ${properties.most_common_rank || 'N/A'}
                `;
                new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);
            };

            map.on('click', 'polygons-layer', showPopup);
            map.on('click', 'ratings-layer', showPopup);

            
            ['centroids-layer', 'polygons-layer', 'ratings-layer'].forEach(id => {
                map.on('mouseenter', id, () => map.getCanvas().style.cursor = 'pointer');
                map.on('mouseleave', id, () => map.getCanvas().style.cursor = '');
            });

            function toggleLayer(layerId, isChecked) {
                if (!map.getLayer(layerId)) return;
                map.setLayoutProperty(layerId, 'visibility', isChecked ? 'visible' : 'none');
            }

            document.getElementById('toggle-polygons').addEventListener('change', (e) => {
                toggleLayer('polygons-layer', e.target.checked);
            });
            document.getElementById('toggle-centroids').addEventListener('change', (e) => {
                toggleLayer('centroids-layer', e.target.checked);
            });
            document.getElementById('toggle-ratings').addEventListener('change', (e) => {
                toggleLayer('ratings-layer', e.target.checked);
            });
        });
    </script>
</body>
</html>